<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“˜ ì–´íœ˜ í”Œë˜ì‹œì¹´ë“œ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans SC', sans-serif;
      background: #f8f9fa;
    }
    h1 {
      text-align: center;
      margin-top: 1rem !important;
      margin-bottom: 1rem !important;
      font-size: 1.8rem;
    }

    .filter-buttons {
      text-align: center;
      margin-bottom: 1rem;
    }

    .filter-buttons button {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 0.4rem 0.8rem;
      margin: 0.25rem;
      font-family: 'Noto Sans SC', sans-serif;
      cursor: pointer;
      transition: background 0.2s;
    }

    .filter-buttons button:hover {
      background: #e6e6e6;
    }

    .filter-buttons button.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }

    /* ì™„ì „íˆ ìƒˆë¡œìš´ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
    .grid {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 10px;
      box-sizing: border-box;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      margin: 0 -1.5px; /* ì¹´ë“œ ì‚¬ì´ ê°„ê²© ë³´ì • */
    }

    .card-column {
      width: 25%; /* í•œ ì¤„ì— 4ê°œ */
      padding: 0 1.5px; /* ì¢Œìš° ê°„ê²© 1.5px */
      margin-bottom: 3px; /* ì•„ë˜ ê°„ê²© 3px */
      box-sizing: border-box;
    }

    .flip-card {
      background-color: transparent;
      width: 100%;
      height: 120px;
      perspective: 1000px;
    }

    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }

    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front,
    .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
      background: white;
      padding: 10px;
      text-align: center;
      box-sizing: border-box;
    }

    .flip-card-back {
      transform: rotateY(180deg);
      background: #f0f0f0;
    }
    
    .error-message {
      text-align: center;
      color: #d9534f;
      padding: 2rem;
      font-weight: bold;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body>

  <h1>ğŸ“˜ ì–´íœ˜ í”Œë˜ì‹œì¹´ë“œ</h1>

  <!-- âœ… í•„í„° ë²„íŠ¼ ì˜ì—­ -->
  <div class="filter-buttons" id="filterButtons"></div>

  <div class="grid" id="cards">
    <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
  </div>


  <script>
    // URLì—ì„œ sheetURL íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
    function getSheetURL() {
      // URLì—ì„œ íŒŒë¼ë¯¸í„° ì¶”ì¶œ
      const urlParams = new URLSearchParams(window.location.search);
      let sheetURL = urlParams.get('url');
      
      console.log("ë°›ì€ URL íŒŒë¼ë¯¸í„°:", sheetURL); // ë””ë²„ê¹…ìš©
      
      // URL íŒŒë¼ë¯¸í„°ê°€ ì—†ëŠ” ê²½ìš°
      if (!sheetURL) {
        console.log("URL íŒŒë¼ë¯¸í„° ì—†ìŒ, ì˜¤ë¥˜ í‘œì‹œ"); // ë””ë²„ê¹…ìš©
        return null; // ê¸°ë³¸ê°’ ëŒ€ì‹  null ë°˜í™˜
      }
      
      // URL ë””ì½”ë”© (URLì´ ì´ë¯¸ ì¸ì½”ë”©ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŒ)
      try {
        if (sheetURL.includes('%')) {
          sheetURL = decodeURIComponent(sheetURL);
          console.log("URL ë””ì½”ë”© í›„:", sheetURL); // ë””ë²„ê¹…ìš©
        }
      } catch (e) {
        console.error("URL ë””ì½”ë”© ì˜¤ë¥˜:", e); // ë””ë²„ê¹…ìš©
      }
      
      // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDë§Œ ì „ë‹¬ëœ ê²½ìš° (URLì´ ì•„ë‹Œ IDë§Œ ìˆëŠ” ê²½ìš°)
      if (!sheetURL.includes('http') && !sheetURL.includes('spreadsheets')) {
        console.log("IDë§Œ ì „ë‹¬ë¨, URL êµ¬ì„±"); // ë””ë²„ê¹…ìš©
        sheetURL = `https://docs.google.com/spreadsheets/d/${sheetURL}`;
      }
      
      // URLì´ gviz íŒŒë¼ë¯¸í„°ë¥¼ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸
      if (!sheetURL.includes('gviz/tq?tqx=out:json')) {
        console.log("gviz íŒŒë¼ë¯¸í„° ì¶”ê°€ í•„ìš”"); // ë””ë²„ê¹…ìš©
        
        // ê¸°ë³¸ URL í˜•ì‹ì¸ ê²½ìš° gviz íŒŒë¼ë¯¸í„° ì¶”ê°€
        if (sheetURL.includes('/spreadsheets/d/')) {
          // ë§¨ ëì— ìŠ¬ë˜ì‹œ ë˜ëŠ” edit ë˜ëŠ” ë‹¤ë¥¸ íŒŒë¼ë¯¸í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
          if (sheetURL.endsWith('/')) {
            sheetURL = sheetURL.slice(0, -1);
          }
          
          // edit ë˜ëŠ” ë‹¤ë¥¸ íŒŒë¼ë¯¸í„° ì œê±°
          if (sheetURL.includes('/edit')) {
            sheetURL = sheetURL.split('/edit')[0];
          }
          
          // ê¸°íƒ€ íŒŒë¼ë¯¸í„° ì œê±°
          if (sheetURL.includes('?')) {
            sheetURL = sheetURL.split('?')[0];
          }
          
          // gviz íŒŒë¼ë¯¸í„° ì¶”ê°€
          sheetURL = `${sheetURL}/gviz/tq?tqx=out:json`;
          console.log("ìµœì¢… ë³€í™˜ëœ URL:", sheetURL); // ë””ë²„ê¹…ìš©
        } else {
          console.error('ì˜¬ë°”ë¥¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤');
          return null;
        }
      }
      
      console.log("ìµœì¢… ì‚¬ìš© URL:", sheetURL); // ë””ë²„ê¹…ìš©
      return sheetURL;
    }
    
    // ì¹´ë“œ ì´ˆê¸°í™”
    function initFlashcards() {
      const sheetURL = getSheetURL();
      const container = document.getElementById('cards');
      
      // URLì´ ì—†ëŠ” ê²½ìš° (ì§ì ‘ ì ‘ê·¼ ì‹œ)
      if (!sheetURL) {
        container.innerHTML = `<div class="error-message">
          URL ë§¤ê°œë³€ìˆ˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì´ í˜ì´ì§€ëŠ” ë©”ì¸ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í˜¸ì¶œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        </div>`;
        return;
      }
      
      container.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
      console.log("ë°ì´í„° ìš”ì²­ URL:", sheetURL); // ë””ë²„ê¹…ìš©

      fetch(sheetURL)
        .then(res => {
          console.log("ì‘ë‹µ ìƒíƒœ:", res.status); // ë””ë²„ê¹…ìš©
          if (!res.ok) {
            throw new Error(`ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒíƒœ ì½”ë“œ: ${res.status}`);
          }
          return res.text();
        })
        .then(data => {
          try {
            console.log("ë°ì´í„° ì¼ë¶€:", data.substring(0, 100)); // ë””ë²„ê¹…ìš©
            // êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ API ì‘ë‹µ ì²˜ë¦¬ (ì•ë’¤ ë¬¸ìì—´ ì œê±°)
            const jsonText = data.substr(47).slice(0, -2);
            const json = JSON.parse(jsonText);
            
            if (!json.table || !json.table.rows) {
              throw new Error("ì˜¬ë°”ë¥¸ ë°ì´í„° í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
            }
            
            console.log("íŒŒì‹±ëœ ë°ì´í„° í–‰ ìˆ˜:", json.table.rows.length); // ë””ë²„ê¹…ìš©
            renderCards(json.table.rows);
          } catch (e) {
            console.error("ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", e); // ë””ë²„ê¹…ìš©
            container.innerHTML = `<div class="error-message">ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜: ${e.message}</div>`;
          }
        })
        .catch(error => {
          console.error("API ìš”ì²­ ì˜¤ë¥˜:", error); // ë””ë²„ê¹…ìš©
          container.innerHTML = `<div class="error-message">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
        });
    }
    
    // ì¹´ë“œ ë Œë”ë§ - ìƒˆë¡œìš´ ë°©ì‹
    function renderCards(rows) {
      const container = document.getElementById('cards');
      const filterContainer = document.getElementById('filterButtons');
      
      // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
      container.innerHTML = '';
      filterContainer.innerHTML = '';
      
      const topics = new Set();
      const cards = []; // ì¹´ë“œ ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´

      // ì¹´ë“œ ë°ì´í„° ì¤€ë¹„
      rows.forEach(row => {
        const ko = row.c[0]?.v;
        const zh = row.c[1]?.v;
        const topic = row.c[2]?.v || "ê¸°íƒ€";

        if (ko && zh) {
          cards.push({ ko, zh, topic });
          topics.add(topic);
        }
      });
      
      // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
      if (cards.length === 0) {
        container.innerHTML = '<div class="error-message">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      // ì¹´ë“œ ê·¸ë¦¬ë“œ ìƒì„±
      let currentRow;
      
      cards.forEach((card, index) => {
        // ìƒˆ í–‰ ì‹œì‘ (4ê°œë§ˆë‹¤)
        if (index % 4 === 0) {
          currentRow = document.createElement('div');
          currentRow.className = 'row';
          container.appendChild(currentRow);
        }
        
        // ì¹´ë“œ ì»¬ëŸ¼ ìƒì„±
        const column = document.createElement('div');
        column.className = 'card-column';
        column.setAttribute('data-topic', card.topic);
        
        // í”Œë¦½ ì¹´ë“œ ìƒì„±
        const flipCard = document.createElement('div');
        flipCard.className = 'flip-card';
        
        const inner = document.createElement('div');
        inner.className = 'flip-card-inner';
        
        const front = document.createElement('div');
        front.className = 'flip-card-front';
        front.textContent = card.ko;
        
        const back = document.createElement('div');
        back.className = 'flip-card-back';
        back.textContent = card.zh;
        
        inner.appendChild(front);
        inner.appendChild(back);
        flipCard.appendChild(inner);
        column.appendChild(flipCard);
        currentRow.appendChild(column);
        
        // í´ë¦­ ì´ë²¤íŠ¸
        flipCard.onclick = () => {
          speechSynthesis.cancel();
          const isCurrentlyFlipped = flipCard.classList.contains('flipped');
          const utter = new SpeechSynthesisUtterance(
            isCurrentlyFlipped ? card.ko : card.zh
          );
          utter.lang = isCurrentlyFlipped ? 'ko-KR' : 'zh-CN';
          utter.rate = 0.9;
          speechSynthesis.speak(utter);
          flipCard.classList.toggle('flipped');
        };
      });

      // í•„í„° ë²„íŠ¼ ìƒì„±
      const allButton = document.createElement('button');
      allButton.textContent = 'ì „ì²´';
      allButton.setAttribute('data-topic', 'all');
      allButton.classList.add('active');
      filterContainer.appendChild(allButton);
      
      topics.forEach(topic => {
        const button = document.createElement('button');
        button.textContent = topic;
        button.setAttribute('data-topic', topic);
        filterContainer.appendChild(button);
      });
      
      // í•„í„°ë§ ê¸°ëŠ¥
      document.querySelectorAll('#filterButtons button').forEach(button => {
        button.addEventListener('click', () => {
          // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
          document.querySelectorAll('#filterButtons button').forEach(btn => {
            btn.classList.remove('active');
          });
          
          // í´ë¦­ëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
          button.classList.add('active');
          
          const selected = button.getAttribute('data-topic');
          document.querySelectorAll('.card-column').forEach(column => {
            const cardTopic = column.getAttribute('data-topic');
            column.style.display = (selected === 'all' || selected === cardTopic) ? 'block' : 'none';
          });
        });
      });
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = initFlashcards;
  </script>

</body>
</html>
